<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description"
    content="Malaysian Ham Radio Frequencies: A curated and categorized collection of simplex, repeater, and PMR frequencies. CHIRP-compatible and updated for Malaysian operators." />
  <meta name="keywords"
    content="frekuensi, walkie talkie, pengulang, radio amatur, Malaysia, radio ham, radio amateur, Malaysia ham radio, repeater frequency, simplex, PMR446, CHIRP, amateur radio, VHF, UHF, 9M2PJU" />
  <meta name="author" content="9M2PJU" />
  <title>Malaysian Ham Radio Frequencies</title>
  <link rel="icon" href="my_flag_round.svg" type="image/svg+xml">

  <!-- PWA Support -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#00f3ff">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker registered!', reg))
          .catch(err => console.log('Service Worker registration failed: ', err));
      });
    }
  </script>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Orbitron:wght@400;500;600;700;800;900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
            tech: ['Orbitron', 'sans-serif'],
          },
          colors: {
            neon: {
              blue: '#00f3ff',
              purple: '#bc13fe',
              green: '#0aff68',
            },
            glass: {
              100: 'rgba(255, 255, 255, 0.03)',
              200: 'rgba(255, 255, 255, 0.08)',
              300: 'rgba(255, 255, 255, 0.15)',
              dark: 'rgba(2, 6, 23, 0.7)',
              border: 'rgba(0, 243, 255, 0.2)',
            }
          },
          animation: {
            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'float': 'float 6s ease-in-out infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --glass-border: 1px solid rgba(0, 243, 255, 0.1);
      --glass-shadow: 0 0 15px -3px rgba(0, 243, 255, 0.1), 0 0 6px -2px rgba(188, 19, 254, 0.1);
    }

    body {
      background-color: #050510;
      background-image:
        linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px),
        radial-gradient(at 50% 0%, hsla(258, 60%, 15%, 0.4) 0, transparent 60%),
        radial-gradient(at 0% 0%, hsla(190, 80%, 10%, 0.5) 0, transparent 50%),
        radial-gradient(at 100% 0%, hsla(300, 70%, 12%, 0.5) 0, transparent 50%);
      background-size: 50px 50px, 50px 50px, 100% 100%, 100% 100%, 100% 100%;
      background-attachment: fixed;
    }

    .glass-panel {
      background: rgba(10, 15, 30, 0.5);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: var(--glass-border);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .glass-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(0, 243, 255, 0.5), transparent);
      opacity: 0.5;
    }

    .dark .glass-panel {
      background: rgba(5, 10, 25, 0.8);
      border: 1px solid rgba(0, 243, 255, 0.15);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #050510;
    }

    ::-webkit-scrollbar-thumb {
      background: #1e293b;
      border-radius: 3px;
      border: 1px solid rgba(0, 243, 255, 0.2);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00f3ff;
      box-shadow: 0 0 10px #00f3ff;
    }

    @media print {

      header,
      footer,
      input,
      button {
        display: none !important;
      }

      table {
        page-break-after: always;
      }

      body {
        background: white !important;
        color: black !important;
        background-image: none !important;
      }

      .glass-panel {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
      }
    }

    #photo {
      display: none;
      margin: 0 auto;
      margin-top: 1rem;
    }

    .optimize-visibility {
      content-visibility: auto;
      contain-intrinsic-size: 1000px;
    }
  </style>
</head>

<body class="font-sans antialiased text-gray-100 min-h-screen selection:bg-blue-500 selection:text-white">

  <!-- Navbar -->
  <nav class="fixed top-0 left-0 right-0 z-50 glass-panel border-b border-glass-border">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-3 cursor-pointer" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })">
          <img src="my_flag_round.svg" alt="Malaysia Flag"
            class="w-8 h-8 rounded-full shadow-[0_0_15px_rgba(0,243,255,0.3)]">
          <span class="text-xl font-bold tracking-tight font-tech text-white">MY-<span
              class="text-neon-blue drop-shadow-[0_0_8px_rgba(0,243,255,0.6)]">Ham</span>Freq</span>
        </div>
        <div class="flex items-center gap-4">
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-4 pt-24 pb-12">
    <!-- Hero Section -->
    <div class="text-center mb-8 md:mb-12 relative">
      <div class="absolute inset-0 -z-10 bg-neon-blue/20 blur-[100px] rounded-full opacity-20 pointer-events-none">
      </div>
      <h1
        class="text-3xl md:text-5xl font-black mb-4 bg-clip-text text-transparent bg-gradient-to-r from-neon-blue to-neon-purple font-tech drop-shadow-[0_0_10px_rgba(0,243,255,0.3)] tracking-wide">
        Malaysian Amateur Radio <br class="hidden md:block" /> Frequency Database
      </h1>
      <p class="text-blue-200 text-lg max-w-2xl mx-auto font-light tracking-wide">
        The most comprehensive, curated frequency database for <span class="text-neon-green font-medium">Malaysian
          Amateur Radio Operators</span>.
      </p>
    </div>

    <!-- Stats Dashboard -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div
        class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center group hover:bg-white/5 transition-all hover:shadow-[0_0_20px_rgba(0,243,255,0.15)] hover:-translate-y-1">
        <span class="text-3xl font-bold text-white mb-1 font-tech drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]"
          id="stat-total">-</span>
        <span class="text-xs text-blue-300/70 uppercase tracking-widest font-mono">Total Frequencies</span>
      </div>
      <div
        class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center group hover:bg-white/5 transition-all hover:shadow-[0_0_20px_rgba(10,255,104,0.15)] hover:-translate-y-1">
        <span class="text-3xl font-bold text-neon-green mb-1 font-tech drop-shadow-[0_0_5px_rgba(10,255,104,0.5)]"
          id="stat-simplex">-</span>
        <span class="text-xs text-blue-300/70 uppercase tracking-widest font-mono">Simplex</span>
      </div>
      <div
        class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center group hover:bg-white/5 transition-all hover:shadow-[0_0_20px_rgba(0,243,255,0.15)] hover:-translate-y-1">
        <span class="text-3xl font-bold text-neon-blue mb-1 font-tech drop-shadow-[0_0_5px_rgba(0,243,255,0.5)]"
          id="stat-repeater">-</span>
        <span class="text-xs text-blue-300/70 uppercase tracking-widest font-mono">Repeaters</span>
      </div>
      <div
        class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center group hover:bg-white/5 transition-all hover:shadow-[0_0_20px_rgba(188,19,254,0.15)] hover:-translate-y-1">
        <span class="text-3xl font-bold text-neon-purple mb-1 font-tech drop-shadow-[0_0_5px_rgba(188,19,254,0.5)]"
          id="stat-pmr">-</span>
        <span class="text-xs text-blue-300/70 uppercase tracking-widest font-mono">PMR / LPD</span>
      </div>
    </div>

    <!-- Visitor Stats -->
    <div
      class="glass-panel p-4 rounded-xl mb-8 flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-12 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-32 h-32 bg-neon-purple/20 blur-[60px] rounded-full pointer-events-none">
      </div>
      <div class="absolute bottom-0 left-0 w-32 h-32 bg-neon-blue/20 blur-[60px] rounded-full pointer-events-none">
      </div>

      <div class="flex items-center gap-3 relative z-10">
        <div
          class="w-10 h-10 rounded-lg skew-x-[-10deg] bg-neon-green/10 text-neon-green flex items-center justify-center border border-neon-green/30 shadow-[0_0_10px_rgba(10,255,104,0.2)]">
          <i class="fa-solid fa-users skew-x-[10deg]"></i>
        </div>
        <div class="flex flex-col">
          <span class="text-xs text-blue-300/70 uppercase tracking-widest font-mono mb-1">Total Visitors</span>
          <img
            src="https://api.visitorbadge.io/api/visitors?path=pass.hamradio.my&label=&countColor=%230aff68&labelColor=%230aff68&style=flat"
            alt="Total Visitors"
            class="h-5 w-auto opacity-90 hover:opacity-100 transition-opacity rounded-sm shadow-[0_0_10px_rgba(10,255,104,0.3)]">
        </div>
      </div>

      <div class="hidden sm:block w-px h-10 bg-gradient-to-b from-transparent via-blue-500/30 to-transparent"></div>

      <div class="flex items-center gap-3 relative z-10">
        <div
          class="w-10 h-10 rounded-lg skew-x-[-10deg] bg-neon-blue/10 text-neon-blue flex items-center justify-center border border-neon-blue/30 shadow-[0_0_10px_rgba(0,243,255,0.2)]">
          <i class="fa-solid fa-earth-asia skew-x-[10deg]"></i>
        </div>
        <div class="flex flex-col">
          <span class="text-xs text-blue-300/70 uppercase tracking-widest font-mono mb-1">Online Now</span>
          <div
            class="mt-0.5 filter grayscale hover:grayscale-0 transition-all opacity-90 hover:opacity-100 hover:drop-shadow-[0_0_5px_rgba(0,243,255,0.5)]">
            <a href="https://whos.amung.us/stats/9m2pjuradio/">
              <img src="https://whos.amung.us/widget/9m2pjuradio.png" alt="web stats" width="81" height="29"
                border="0" />
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Controls Section -->
    <div
      class="glass-panel p-4 rounded-2xl mb-8 sticky top-20 z-40 shadow-[0_10px_30px_rgba(0,0,0,0.5)] backdrop-blur-xl border-t border-glass-border">
      <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
        <!-- Search -->
        <div class="relative w-full md:w-96 group">
          <i
            class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-blue-400 group-focus-within:text-neon-blue transition-colors"></i>
          <input id="search" type="text" placeholder="Search callsign, frequency, or location..."
            class="w-full pl-10 pr-4 py-2.5 bg-black/40 border border-glass-border rounded-xl focus:outline-none focus:border-neon-blue focus:shadow-[0_0_15px_rgba(0,243,255,0.2)] text-white placeholder-blue-300/30 transition-all font-mono text-sm">
        </div>

        <!-- Filters -->
        <div class="flex flex-wrap items-center justify-center gap-2" id="filters">
          <button
            class="filter-chip active px-4 py-1.5 rounded-none skew-x-[-10deg] text-xs font-bold border border-neon-blue/50 bg-neon-blue/10 text-neon-blue hover:bg-neon-blue/20 hover:shadow-[0_0_10px_rgba(0,243,255,0.3)] transition-all uppercase tracking-wider"
            data-filter="all"><span class="skew-x-[10deg] inline-block">All</span></button>
          <button
            class="filter-chip px-4 py-1.5 rounded-none skew-x-[-10deg] text-xs font-bold border border-white/5 hover:border-white/20 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-all uppercase tracking-wider"
            data-filter="VHF"><span class="skew-x-[10deg] inline-block">VHF</span></button>
          <button
            class="filter-chip px-4 py-1.5 rounded-none skew-x-[-10deg] text-xs font-bold border border-white/5 hover:border-white/20 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-all uppercase tracking-wider"
            data-filter="UHF"><span class="skew-x-[10deg] inline-block">UHF</span></button>
          <button
            class="filter-chip px-4 py-1.5 rounded-none skew-x-[-10deg] text-xs font-bold border border-white/5 hover:border-white/20 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-all uppercase tracking-wider"
            data-filter="Simplex"><span class="skew-x-[10deg] inline-block">Simplex</span></button>
          <button
            class="filter-chip px-4 py-1.5 rounded-none skew-x-[-10deg] text-xs font-bold border border-white/5 hover:border-white/20 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition-all uppercase tracking-wider"
            data-filter="Repeaters"><span class="skew-x-[10deg] inline-block">Repeaters</span></button>
        </div>

        <!-- Download Action -->
        <div class="flex items-center gap-3 border-l border-white/10 pl-3">
          <button onclick="getUserLocation()" id="geo-btn"
            class="flex items-center gap-2 text-sm text-gray-400 hover:text-white transition-colors group"
            title="Sort by Distance">
            <i class="fa-solid fa-location-crosshairs group-hover:text-blue-400"></i> <span
              class="hidden sm:inline">Near Me</span>
          </button>
          <a href="9M2PJU.csv" download
            class="flex items-center gap-2 text-sm text-gray-400 hover:text-white transition-colors">
            <i class="fa-solid fa-cloud-arrow-down"></i> CSV
          </a>
        </div>
      </div>
    </div>

    <div id="output" class="space-y-8">
      <div class="flex flex-col items-center justify-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-gray-500">Loading frequency database...</p>
      </div>
    </div>

    <!-- Hidden Support Image -->
    <div id="photo" class="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm"
      onclick="togglePhoto()">
      <div class="max-w-md w-full glass-panel p-2 rounded-2xl animate-in fade-in zoom-in duration-200">
        <img src="https://drive.google.com/thumbnail?id=1lf1zgIN1Kx5cduZM79n3boGDJQ68uSJ_&sz=w1000" alt="Support"
          class="w-full rounded-xl">
        <p class="text-center text-gray-400 text-xs mt-2">Click anywhere to close</p>
      </div>
    </div>
  </main>

  <footer class="text-center text-sm text-gray-600 py-8 border-t border-white/5">
    <p>&copy; <span id="year"></span> Malaysian Amateur Radio Frequency Database.</p>
    <p class="mt-1">Made for ðŸ‡²ðŸ‡¾ by <a href="https://hamradio.my"
        class="text-blue-400 hover:text-blue-300 transition-colors">9M2PJU</a>.
    </p>
  </footer>

  <!-- Back to Top Button -->
  <button id="backToTop"
    class="fixed bottom-6 right-6 w-12 h-12 rounded-full bg-neon-blue/10 border border-neon-blue/50 text-neon-blue shadow-[0_0_15px_rgba(0,243,255,0.4)] backdrop-blur-md z-50 transition-all duration-300 hover:bg-neon-blue/20 hover:scale-110 opacity-0 translate-y-10 invisible flex items-center justify-center group"
    aria-label="Back to Top">
    <i class="fa-solid fa-arrow-up group-hover:-translate-y-1 transition-transform"></i>
  </button>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const output = document.getElementById('output');
    const searchInput = document.getElementById('search');
    let allRows = [];
    let currentFilter = 'all';
    let userLat = null;
    let userLon = null;

    function togglePhoto() {
      const photo = document.getElementById('photo');
      const isHidden = photo.classList.contains('hidden');
      if (isHidden) {
        photo.classList.remove('hidden');
        photo.classList.add('flex');
      } else {
        photo.classList.add('hidden');
        photo.classList.remove('flex');
      }
    }
    // Init hidden state for photo
    document.getElementById('photo').classList.add('hidden');

    function bandBadge(freq) {
      if (freq >= 446 && freq <= 446.2)
        return `<span class="inline-flex items-center px-2 py-0.5 rounded-sm skew-x-[-10deg] text-[10px] font-bold bg-neon-purple/10 text-neon-purple border border-neon-purple/50 shadow-[0_0_8px_rgba(188,19,254,0.3)] min-w-[50px] justify-center"><span class="skew-x-[10deg]">PMR</span></span>`;
      if (freq < 300)
        return `<span class="inline-flex items-center px-2 py-0.5 rounded-sm skew-x-[-10deg] text-[10px] font-bold bg-neon-green/10 text-neon-green border border-neon-green/50 shadow-[0_0_8px_rgba(10,255,104,0.3)] min-w-[50px] justify-center"><span class="skew-x-[10deg]">VHF</span></span>`;
      return `<span class="inline-flex items-center px-2 py-0.5 rounded-sm skew-x-[-10deg] text-[10px] font-bold bg-neon-blue/10 text-neon-blue border border-neon-blue/50 shadow-[0_0_8px_rgba(0,243,255,0.3)] min-w-[50px] justify-center"><span class="skew-x-[10deg]">UHF</span></span>`;
    }

    function updateStats(rows) {
      document.getElementById('stat-total').textContent = rows.length;
      document.getElementById('stat-simplex').textContent = rows.filter(r => {
        const f = parseFloat(r.Frequency) || 0;
        const o = parseFloat(r.Offset) || 0;
        return o === 0 && !(f >= 446 && f <= 446.2);
      }).length;
      document.getElementById('stat-repeater').textContent = rows.filter(r => {
        const f = parseFloat(r.Frequency) || 0;
        const o = parseFloat(r.Offset) || 0;
        return o !== 0;
      }).length;
      document.getElementById('stat-pmr').textContent = rows.filter(r => {
        const f = parseFloat(r.Frequency) || 0;
        return f >= 446 && f <= 446.2;
      }).length;
    }

    function copyToClipboard(text, btn) {
      navigator.clipboard.writeText(text).then(() => {
        const originalIcon = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-check text-neon-green"></i>';
        setTimeout(() => {
          btn.innerHTML = originalIcon;
        }, 2000);
      });
    }

    // Haversine Formula
    function calculateDistance(lat1, lon1, lat2, lon2) {
      if (!lat1 || !lon1 || !lat2 || !lon2) return null;
      const R = 6371; // Radius of the earth in km
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      const d = R * c; // Distance in km
      return d;
    }

    function deg2rad(deg) {
      return deg * (Math.PI / 180)
    }

    function updateDistances(lat, lon) {
      if (!lat || !lon) return;
      allRows.forEach(r => {
        if (r.Latitude && r.Longitude) {
          const dist = calculateDistance(lat, lon, parseFloat(r.Latitude), parseFloat(r.Longitude));
          r.distance = (dist !== null && !isNaN(dist)) ? dist : Infinity;
        } else {
          r.distance = Infinity;
        }
      });
    }

    function getUserLocation() {
      const btn = document.getElementById('geo-btn');
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-neon-blue"></i> Locating...';

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;

            updateDistances(userLat, userLon);

            btn.innerHTML = '<i class="fa-solid fa-location-dot text-neon-green"></i> Location Set';
            btn.classList.add('text-neon-green');
            // Re-render with sorting
            render(allRows);
          },
          (error) => {
            console.error("Error getting location:", error);
            let msg = "Error";
            if (error.code === 1) msg = "Permission Denied";
            else if (error.code === 2) msg = "Position Unavailable";
            // 3 is Timeout

            alert("Geolocation Error: " + msg + "\\nPlease enable location services for this website in your browser settings.");

            btn.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-400"></i> ' + msg;
            setTimeout(() => {
              btn.innerHTML = '<i class="fa-solid fa-location-crosshairs group-hover:text-neon-blue"></i> <span class="hidden sm:inline">Near Me</span>';
            }, 3000);
          }
        );
      } else {
        alert("Geolocation is not supported by this browser.");
        btn.innerHTML = 'Not Supported';
      }
    }

    function createCard(r) {
      const freq = parseFloat(r.Frequency).toFixed(3);

      let distHtml = '';
      if (typeof r.distance === 'number' && r.distance !== Infinity) {
        distHtml = `<div class="text-[10px] font-mono text-neon-blue bg-neon-blue/10 px-2 py-0.5 rounded-sm border border-neon-blue/30 whitespace-nowrap shadow-[0_0_5px_rgba(0,243,255,0.2)]">
                    <i class="fa-solid fa-location-arrow mr-1"></i>${r.distance.toFixed(1)} <span class="text-[9px]">km</span>
                </div>`;
      }

      return `
        <div class="glass-panel p-4 rounded-xl hover:bg-white/5 transition-all border border-transparent hover:border-neon-blue/50 group relative hover:shadow-[0_0_20px_rgba(0,243,255,0.1)] hover:-translate-y-1 duration-300">
             <div class="absolute inset-0 bg-gradient-to-br from-neon-blue/5 to-neon-purple/5 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl"></div>
            <div class="flex justify-between items-start mb-2 gap-2 relative z-10">
                <div class="min-w-0 flex-1">
                   <div class="flex items-center gap-2 flex-wrap mb-1">
                      <h3 class="font-bold text-lg text-white group-hover:text-neon-blue transition-colors truncate font-tech tracking-wide drop-shadow-sm shadow-black">${r.Name}</h3>
                      ${distHtml}
                   </div>
                   <div class="text-xs text-blue-200/60 truncate font-mono"><i class="fa-solid fa-location-dot mr-1"></i> ${r.Comment || 'No location info'}</div>
                </div>
                <div class="shrink-0">
                    ${bandBadge(parseFloat(r.Frequency))}
                </div>
            </div>
            
            <div class="flex items-center gap-3 my-4 relative z-10 bg-black/20 p-2 rounded-lg border border-white/5 group-hover:border-white/10 transition-colors">
                <div class="text-2xl font-mono font-bold text-white tracking-wider drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">${freq} <span class="text-xs text-gray-500 font-sans">MHz</span></div>
                <button onclick="copyToClipboard('${freq}', this)" class="w-8 h-8 rounded-full bg-white/5 hover:bg-neon-blue/20 flex items-center justify-center text-gray-400 hover:text-neon-blue transition-all ml-auto hover:shadow-[0_0_10px_rgba(0,243,255,0.4)]" title="Copy Frequency">
                    <i class="fa-regular fa-copy"></i>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-y-2 text-sm text-gray-400 pt-3 border-t border-white/5 relative z-10">
                <div class="flex items-center gap-2">
                    <span class="w-16 text-[10px] uppercase tracking-wider text-blue-300/50 font-mono">Tone</span>
                    <span class="${r.Tone ? 'text-gray-200' : 'text-gray-600'} font-mono">${r.Tone || '-'}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-16 text-[10px] uppercase tracking-wider text-blue-300/50 font-mono">Offset</span>
                     <span class="${parseFloat(r.Offset) !== 0 ? 'text-neon-blue drop-shadow-[0_0_3px_rgba(0,243,255,0.5)]' : 'text-gray-600'} font-mono">${parseFloat(r.Offset) !== 0 ? r.Offset : 'Simplex'}</span>
                </div>
                 <div class="flex items-center gap-2">
                    <span class="w-16 text-[10px] uppercase tracking-wider text-blue-300/50 font-mono">Mode</span>
                    <span class="font-mono text-gray-300">${r.Mode}</span>
                </div>
            </div>
        </div>
        `;
    }

    function createSection(title, rows) {
      if (rows.length === 0) return '';
      const grid = rows.map(r => createCard(r)).join('');
      return `
            <section class="animate-in fade-in slide-in-from-bottom-4 duration-500 mb-8 optimize-visibility">
                <div class="flex items-center gap-3 mb-6">
                   <div class="w-1 h-6 bg-neon-blue shadow-[0_0_8px_#00f3ff]"></div>
                    <h2 class="text-2xl font-bold text-white font-tech tracking-wide">${title}</h2>
                    <span class="px-2 py-0.5 rounded text-xs text-neon-blue bg-neon-blue/10 border border-neon-blue/30 font-mono">${rows.length}</span>
                    <div class="h-px bg-gradient-to-r from-neon-blue/50 to-transparent flex-grow ml-4"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${grid}
                </div>
            </section>
        `;
    }

    function render(rows) {
      output.innerHTML = '';

      // Filter logic
      let filtered = rows;
      if (currentFilter !== 'all') {
        filtered = rows.filter(r => {
          const f = parseFloat(r.Frequency) || 0;
          const o = parseFloat(r.Offset) || 0;
          if (currentFilter === 'VHF') return f < 300;
          if (currentFilter === 'UHF') return f >= 300;
          if (currentFilter === 'Simplex') return o === 0 && !(f >= 446 && f <= 446.2);
          if (currentFilter === 'Repeaters') return o !== 0;
          return true;
        });
      }

      // Sorting Logic (if location available)
      if (userLat && userLon) {
        filtered.sort((a, b) => {
          const distA = (typeof a.distance === 'number') ? a.distance : Infinity;
          const distB = (typeof b.distance === 'number') ? b.distance : Infinity;
          return distA - distB;
        });
      }

      const groups = { Simplex: [], Repeaters: [], PMR: [] };

      filtered.forEach(r => {
        const f = parseFloat(r.Frequency) || 0;
        const o = parseFloat(r.Offset) || 0;
        let cat = 'Repeaters';
        if (f >= 446 && f <= 446.2) cat = 'PMR';
        else if (o === 0) cat = 'Simplex';

        groups[cat].push(r);
      });

      let html = '';
      ['PMR', 'Repeaters', 'Simplex'].forEach(cat => {
        html += createSection(cat === 'PMR' ? 'PMR / LPD (446 MHz)' : cat, groups[cat]);
      });

      if (filtered.length === 0 && rows.length > 0) {
        html = `<div class="text-center py-20 text-gray-500">No results found for your filter/search.</div>`;
      }

      output.innerHTML = html;
      updateStats(rows);
    }

    // Filter Chips Logic
    document.querySelectorAll('.filter-chip').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.filter-chip').forEach(b => {
          b.classList.remove('bg-neon-blue/10', 'text-neon-blue', 'border-neon-blue/50', 'active', 'shadow-[0_0_10px_rgba(0,243,255,0.3)]');
          b.classList.add('text-gray-400', 'border-white/5', 'bg-white/5');
        });
        btn.classList.remove('text-gray-400', 'border-white/5', 'bg-white/5');
        btn.classList.add('bg-neon-blue/10', 'text-neon-blue', 'border-neon-blue/50', 'active', 'shadow-[0_0_10px_rgba(0,243,255,0.3)]');

        currentFilter = btn.dataset.filter;
        const q = searchInput.value.toLowerCase();
        const searchFiltered = allRows.filter(r => Object.values(r).join(' ').toLowerCase().includes(q));
        render(searchFiltered);
      };
    });

    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    searchInput.oninput = debounce(() => {
      const q = searchInput.value.toLowerCase();
      render(allRows.filter(r => Object.values(r).join(' ').toLowerCase().includes(q)));
    }, 300);

    // Parse CSV with cache busting
    Papa.parse('9M2PJU.csv?v=' + new Date().getTime(), {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: r => {
        allRows = r.data.filter(x => x.Name || x.Frequency);
        render(allRows);
        // Auto-request geolocation after data loads
        autoRequestLocation();
      }
    });

    // Quietly request location on page load
    function autoRequestLocation() {
      if (navigator.geolocation) {
        const btn = document.getElementById('geo-btn');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-neon-blue"></i> <span class="hidden sm:inline">Detecting...</span>';

        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;

            updateDistances(userLat, userLon);

            btn.innerHTML = '<i class="fa-solid fa-location-dot text-neon-green"></i> <span class="hidden sm:inline">Sorted by Distance</span>';
            btn.classList.add('text-neon-green');
            render(allRows);
          },
          (error) => {
            // Silently fail - just reset button
            btn.innerHTML = '<i class="fa-solid fa-location-crosshairs group-hover:text-neon-blue"></i> <span class="hidden sm:inline">Near Me</span>';
          },
          { timeout: 10000, maximumAge: 300000 } // 10s timeout, cache for 5 min
        );
      }
    }
    // Back to Top Logic
    const backToTopBtn = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
        backToTopBtn.classList.remove('opacity-0', 'translate-y-10', 'invisible');
      } else {
        backToTopBtn.classList.add('opacity-0', 'translate-y-10', 'invisible');
      }
    });

    backToTopBtn.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
  </script>

</body>

</html>